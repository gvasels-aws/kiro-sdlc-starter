name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    # Only trigger on 'opened', NOT 'assigned' - prevents duplicate runs
    # when an issue is opened and auto-assigned simultaneously
    types: [opened]
  pull_request_review:
    types: [submitted]

# Prevent duplicate runs on the same issue/PR
# Cancel in-progress runs when a new one starts for the same context
concurrency:
  group: claude-${{ github.event.issue.number || github.event.pull_request.number || github.event.comment.id }}
  cancel-in-progress: false  # Don't cancel, just prevent duplicates

jobs:
  claude:
    # Filter out bot comments to prevent duplicate runs when Claude posts tracking comments
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issues' && github.event.action == 'opened' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Uncomment the tools needed for your project:

      # - name: Setup Go
      #   uses: actions/setup-go@v5
      #   with:
      #     go-version: '1.22'

      # - name: Setup Python and uv (for MCP servers)
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: '3.12'
      # - name: Install uv
      #   run: |
      #     curl -LsSf https://astral.sh/uv/install.sh | sh
      #     echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # - name: Setup OpenTofu
      #   uses: opentofu/setup-opentofu@v1
      #   with:
      #     tofu_version: "1.6.0"
      #     tofu_wrapper: true

      - name: Install security tools
        run: |
          # Install gitleaks for secrets detection
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz | tar -xz -C /usr/local/bin gitleaks
          # Install checkov for IaC security (uncomment if using Terraform/OpenTofu)
          # pip install checkov
          # Install golangci-lint (uncomment if using Go)
          # curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b /usr/local/bin v1.55.2

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--max-turns 100"
          additional_permissions: |
            actions: read
          # Branch naming: claude/issue-{number}-{description}
          branch_prefix: "claude/issue-"
          base_branch: "main"  # Change to "dev" when environment branches exist
          # Enable progress tracking to post comments even with custom prompt
          track_progress: true

          # Custom prompt for implementation with 5-phase development + PR-level automation
          prompt: |
            ## YOUR TASK

            You are an AI developer implementing features using a **5-Phase Development Workflow**.
            Security review and code review happen automatically at PR level (CI) to save tokens.

            Read and follow the project's CLAUDE.md file for all conventions and standards.

            ## DEVELOPMENT WORKFLOW (5 Phases)

            ```
            1.SPEC → 2.TEST → 3.CODE → 4.BUILD → 5.DOCS → CREATE PR
                                                              │
                                                    ┌─────────┴─────────┐
                                                    │  PR-Level (Auto)  │
                                                    │  • Security Audit │
                                                    │  • Code Review    │
                                                    └───────────────────┘
            ```

            ### PHASE 1: SPECIFICATION (spec-workflow MCP)

            Before any code:
            1. Read the GitHub issue requirements
            2. Check if spec exists in `.spec-workflow/specs/`
            3. If no spec exists, use spec-workflow MCP to create:
               - `requirements.md` - User stories, acceptance criteria
               - `design.md` - Data models, API contracts
               - `tasks.md` - Implementation breakdown
            4. Read existing specs: `design.md` for schemas, `tasks.md` for task details

            ### PHASE 2: TESTING (test-engineer agent) - TDD RED PHASE

            **MANDATORY**: Write failing tests BEFORE any implementation code.

            ```
            USE Task tool with subagent_type='test-engineer' to:
            - Write unit tests for data models/validation
            - Write integration tests for API endpoints
            - Tests MUST fail initially (Red phase of TDD)
            ```

            ### PHASE 3: IMPLEMENTATION (implementation-agent) - TDD GREEN PHASE

            **ONLY after tests exist and fail**, implement code to make them pass.

            ```
            USE Task tool with subagent_type='implementation-agent' to:
            - Implement data models and validation
            - Implement business logic
            - Create API endpoints or infrastructure
            - Make all tests pass (Green phase of TDD)
            ```

            ### PHASE 4: BUILD VERIFICATION

            Run build verification commands directly:

            ```bash
            # For Node.js/TypeScript:
            npm run lint && npm run typecheck && npm test && npm run build

            # For Go:
            go build ./... && go test ./... -v

            # For OpenTofu:
            tofu init && tofu validate
            ```

            **Quality Gates**: 0 errors, all tests pass

            ### PHASE 5: DOCUMENTATION (documentation-generator agent)

            ```
            USE Task tool with subagent_type='documentation-generator' to:
            - Create CLAUDE.md in new directories
            - Add code comments to public functions
            - **REQUIRED**: Update CHANGELOG.md with feature entry
            ```

            ### CREATE PR

            After phases 1-5, create PR:
            ```bash
            gh pr create --title "Feature: [description]" --body "..."
            ```

            **Security and Code Review run automatically in CI on the PR.**

            ## BRANCHING STRATEGY

            Follow the project's branching model:
            - Group branches: `group-N/{name}` from integration branch
            - Task branches: `task-N.X/{description}` from group branch
            - Merge: task → group → integration branch (main or dev)

            ## PHASE EXECUTION CHECKLIST

            Use TodoWrite to track progress:
            ```
            [ ] Phase 1: Read specs / create if missing
            [ ] Phase 2: Spawn test-engineer - write failing tests
            [ ] Phase 3: Spawn implementation-agent - make tests pass
            [ ] Phase 4: Run build verification commands
            [ ] Phase 5: Spawn documentation-generator - docs + CHANGELOG
            [ ] Create PR (CI handles security + code review)
            ```

            ## START NOW

            1. Read the GitHub issue
            2. Read CLAUDE.md and specs
            3. Execute phases 1-5, then create PR
            4. Do NOT skip the test-engineer phase - TDD is mandatory
