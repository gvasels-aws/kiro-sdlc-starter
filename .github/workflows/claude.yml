name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    # Filter out bot comments to prevent duplicate runs when Claude posts tracking comments
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && github.event.review.user.type != 'Bot') ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Uncomment the tools needed for your project:

      # - name: Setup Go
      #   uses: actions/setup-go@v5
      #   with:
      #     go-version: '1.22'

      # - name: Setup OpenTofu
      #   uses: opentofu/setup-opentofu@v1
      #   with:
      #     tofu_version: "1.6.0"
      #     tofu_wrapper: true

      - name: Install security tools
        run: |
          # Install gitleaks for secrets detection
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz | tar -xz -C /usr/local/bin gitleaks
          # Install checkov for IaC security (uncomment if using Terraform/OpenTofu)
          # pip install checkov
          # Install golangci-lint (uncomment if using Go)
          # curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b /usr/local/bin v1.55.2

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--max-turns 50"
          additional_permissions: |
            actions: read
          # Branch naming: claude/issue-{number}-{description}
          # All claude branches can be merged to main when ready
          branch_prefix: "claude/issue-"
          base_branch: "main"
          # Enable progress tracking to post comments even with custom prompt
          # By default, automation mode (with prompt) disables tracking comments
          track_progress: true

          # Custom prompt for implementation with explicit 7-phase SDLC workflow
          prompt: |
            ## YOUR TASK

            You are an AI developer implementing features using a **MANDATORY 7-Phase SDLC Workflow**.
            You MUST execute ALL phases in order, spawning the appropriate subagents for each phase.

            Read and follow the project's CLAUDE.md file for all conventions and standards.

            ## MANDATORY 7-PHASE SDLC WORKFLOW

            **CRITICAL**: You MUST use the Task tool to spawn subagents for each phase. Do NOT skip phases.

            ### PHASE 1: SPECIFICATION (spec-workflow MCP)

            Before any code:
            1. Read the GitHub issue requirements
            2. Check if spec exists in `.spec-workflow/specs/`
            3. If no spec exists, use spec-workflow MCP to create:
               - `requirements.md` - User stories, acceptance criteria
               - `design.md` - Data models, API contracts
               - `tasks.md` - Implementation breakdown
            4. Read existing specs: `design.md` for schemas, `tasks.md` for task details

            ### PHASE 2: TESTING (test-engineer agent) - TDD RED PHASE

            **MANDATORY**: Write failing tests BEFORE any implementation code.

            ```
            USE Task tool with subagent_type='test-engineer' to:
            - Write unit tests for data models/validation
            - Write integration tests for API endpoints
            - Write contract tests for response schemas
            - Tests MUST fail initially (Red phase of TDD)
            ```

            Example Task invocation:
            ```
            Task(
              subagent_type='test-engineer',
              prompt='Write comprehensive failing tests for [feature].
                      Read design.md for schemas and contracts.
                      Create tests in tests/ directory.
                      Tests should cover: happy paths, error cases, edge cases.
                      Verify tests fail before implementation.'
            )
            ```

            ### PHASE 3: IMPLEMENTATION (implementation-agent) - TDD GREEN PHASE

            **ONLY after tests exist and fail**, implement code to make them pass.

            ```
            USE Task tool with subagent_type='implementation-agent' to:
            - Implement data models and validation
            - Implement business logic
            - Create API endpoints or infrastructure
            - Make all tests pass (Green phase of TDD)
            ```

            Example Task invocation:
            ```
            Task(
              subagent_type='implementation-agent',
              prompt='Implement [feature] to make the failing tests pass.
                      Read design.md for specifications.
                      Write minimal code to pass tests.
                      Run tests after each change to verify progress.'
            )
            ```

            ### PHASE 4: BUILD VERIFICATION

            Run build verification commands directly:

            ```bash
            # For Node.js/TypeScript:
            npm run lint && npm run typecheck && npm test -- --coverage && npm run build

            # For Go:
            go build ./... && go vet ./... && golangci-lint run ./... && go test ./... -v -cover

            # For OpenTofu/Terraform:
            tofu init && tofu validate && tofu fmt -check
            ```

            **Quality Gates**:
            - 0 lint errors
            - 0 type/vet errors
            - All tests pass
            - 80%+ code coverage (where applicable)

            ### PHASE 5: SECURITY AUDIT (security-auditor agent)

            ```
            USE Task tool with subagent_type='security-auditor' to:
            - Run dependency vulnerability scan (npm audit / govulncheck)
            - Run secrets detection (gitleaks detect --source .)
            - Run SAST analysis (semgrep --config=auto .)
            - For infrastructure: run checkov scan
            ```

            Example Task invocation:
            ```
            Task(
              subagent_type='security-auditor',
              prompt='Perform security audit on the new code in [paths].
                      Run: gitleaks detect --source .
                      Run: npm audit (or govulncheck for Go)
                      Check for OWASP Top 10 vulnerabilities.
                      Report any critical/high findings.'
            )
            ```

            **Gate**: 0 critical/high vulnerabilities

            ### PHASE 6: DOCUMENTATION (documentation-generator agent)

            ```
            USE Task tool with subagent_type='documentation-generator' to:
            - Generate/update OpenAPI specs for APIs
            - Add TSDoc/JSDoc/GoDoc comments to public functions
            - Create CLAUDE.md in new directories (REQUIRED)
            - Update CHANGELOG.md with feature entry
            ```

            Example Task invocation:
            ```
            Task(
              subagent_type='documentation-generator',
              prompt='Generate documentation for the new code.
                      Create CLAUDE.md in any new directories.
                      Add code comments to public functions.
                      Update CHANGELOG.md with the feature entry.
                      Update root CLAUDE.md if structure changed.'
            )
            ```

            ### PHASE 7: VERIFICATION (post-PR creation)

            After creating PR:
            1. Verify all CI checks pass
            2. Add PR description with:
               - Summary of changes
               - Test coverage report
               - Security scan results
               - Documentation updates
            3. For deployed services: run smoke tests against API endpoints

            ## PHASE EXECUTION CHECKLIST

            Use TodoWrite to track progress through phases:
            ```
            [ ] Phase 1: Read specs / create if missing
            [ ] Phase 2: Spawn test-engineer - write failing tests
            [ ] Phase 3: Spawn implementation-agent - make tests pass
            [ ] Phase 4: Run build verification commands
            [ ] Phase 5: Spawn security-auditor - security scan
            [ ] Phase 6: Spawn documentation-generator - create docs
            [ ] Phase 7: Create PR with full description
            ```

            ## START NOW

            1. Read the GitHub issue
            2. Read CLAUDE.md and specs
            3. Execute ALL 7 phases in order
            4. Do NOT skip the test-engineer phase - TDD is mandatory
            5. Use Task tool to spawn subagents as specified above

