name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Uncomment the tools needed for your project:

      # - name: Setup Go
      #   uses: actions/setup-go@v5
      #   with:
      #     go-version: '1.22'

      # - name: Setup OpenTofu
      #   uses: opentofu/setup-opentofu@v1
      #   with:
      #     tofu_version: "1.6.0"
      #     tofu_wrapper: true

      - name: Install security tools
        run: |
          # Install gitleaks for secrets detection
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz | tar -xz -C /usr/local/bin gitleaks
          # Install checkov for IaC security (uncomment if using Terraform/OpenTofu)
          # pip install checkov
          # Install golangci-lint (uncomment if using Go)
          # curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b /usr/local/bin v1.55.2

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--max-turns 50"
          additional_permissions: |
            actions: read
          # Branch naming: claude/issue-{number}-{description}
          # All claude branches can be merged to main when ready
          branch_prefix: "claude/issue-"
          base_branch: "main"
          # Enable progress tracking to post comments even with custom prompt
          # By default, automation mode (with prompt) disables tracking comments
          track_progress: true

          # System prompt with full SDLC workflow
          prompt: |
            ## Project Standards (MUST FOLLOW)

            Read and follow the project's CLAUDE.md file for all conventions and standards.

            ## 7-Phase SDLC Workflow (MANDATORY)

            For ALL implementation tasks, follow the complete SDLC workflow from `.claude/plugins/`:

            ### Phase 1: SPEC (spec-writer plugin)
            - Check if spec exists in `.spec-workflow/specs/`
            - If no spec exists for this feature, create one first
            - Ensure requirements.md, design.md, and tasks.md are complete

            ### Phase 2: TEST (test-writer plugin)
            - Write failing tests BEFORE implementation (TDD)
            - Use test-engineer agent for complex test scenarios
            - Create unit tests, integration tests, and contract tests
            - Tests should fail initially - this is expected!

            ### Phase 3: CODE (code-implementer plugin)
            - Write minimal code to make tests pass
            - Use implementation-agent for complex features
            - Follow the design specifications exactly
            - Refactor only after tests pass

            ### Phase 4: BUILD (builder plugin)
            - Run linting: `npm run lint` (or language-specific linter)
            - Run type checking: `npx tsc --noEmit` (or language-specific)
            - Run full test suite with coverage
            - Verify build artifacts are generated

            ### Phase 5: SECURITY (security-checker plugin)
            - Run dependency scan: `npm audit`
            - Run secrets detection: `gitleaks detect --source .`
            - Run SAST: `semgrep --config=auto .`
            - For IaC: `checkov -d infrastructure/ --framework terraform`
            - Use security-auditor agent for manual review
            - Block if critical/high vulnerabilities found

            ### Phase 6: DOCS (docs-generator plugin)
            - Generate/update OpenAPI specs for API changes
            - Add TSDoc/JSDoc comments to new code
            - **CREATE CLAUDE.md** in EVERY new directory (REQUIRED)
            - Update root CLAUDE.md if structure changed
            - Update CHANGELOG.md with feature entry

            ### Phase 7: VERIFY (deploy-verifier plugin)
            - After deployment, run API smoke tests
            - Validate response schemas match OpenAPI spec
            - Rollback automatically on failure
            - Create incident issue if rollback triggered

            ## Workflow Summary

            ```
            1. Read issue/comment
            2. Check/create spec (Phase 1)
            3. Write failing tests (Phase 2)
            4. Implement code (Phase 3)
            5. Build & verify (Phase 4)
            6. Security scan (Phase 5)
            7. Generate docs (Phase 6)
            8. Create PR
            9. After deploy: Verify (Phase 7)
            ```

            Now proceed with the task, following ALL 7 SDLC phases.

